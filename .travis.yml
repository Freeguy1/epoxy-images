# Travis configuration for epoxy-images
#
# epoxy-images supports release automation to Cloud Storage buckets for branches
# in the m-lab/epoxy-images repository. To achieve this, the build takes the
# following steps:
#
#  * decrypt service account credentials, under keys/*.tar.enc
#  * install the Google Cloud SDK command line tools (gcloud)
#  * cache the gcloud installation and setup
#  * build all epoxy-images
#  * on success, deploy the result to the correct Cloud Storage bucket when
#    the target branch matches a supported deployment target.

services:
- docker

before_install:
# NB: Encrypted values are not defined in forks or pull requests.
# Decrypt the tar archive containing the GCP service account key files.
#
# After unpacking, there should be one service account key file for every GCP
# project referenced in the "deploy" section. These keys authenticate the
# gcloud deploy operations.
- travis/decrypt.sh "$encrypted_af2ac69618ed_iv" "$encrypted_af2ac69618ed_key"
  keys/service-accounts.tar.enc /tmp/service-accounts.tar /tmp

# These directories will be cached on successful "script" builds, and restored,
# if available, to save time on future builds.
cache:
  directories:
    - "$HOME/google-cloud-sdk/"

script:
- docker build -t epoxy-images-builder .
- docker run -t -v $PWD:/images epoxy-images-builder
      /images/setup_stage2.sh /buildtmp /images/vendor
      /images/configs/stage2
      /images/output/stage2_initramfs.cpio.gz
      /images/output/stage2_vmlinuz

- $TRAVIS_BUILD_DIR/travis/install_gcloud.sh

# Deploy steps never trigger on a new Pull Request. Deploy steps will trigger
# after a merge with matching "on:" conditions.
deploy:
# SANDBOX: before code review for development code in a specific branch.
- provider: script
  script: $TRAVIS_BUILD_DIR/travis/deploy_gcs_copy.sh /tmp/mlab-sandbox.json
      $TRAVIS_BUILD_DIR/output/stage2_vmlinuz
      gs://epoxy-mlab-sandbox/stage2/stage2_vmlinuz
  skip_cleanup: true
  on:
    # TODO: update repo
    repo: m-lab/epoxy-images
    # Consider all branches and match using the condition. By default
    # "all_branches" is false, and the condition is ignored.
    all_branches: true
    # A bash-style 'if' condition, matching branches with a "sandbox-" prefix.
    condition: $TRAVIS_BRANCH == sandbox-*

# STAGING: after code review and before QA testing.
- provider: script
  script: $TRAVIS_BUILD_DIR/travis/deploy_gcs_copy.sh /tmp/mlab-staging.json
      $TRAVIS_BUILD_DIR/output/stage2_vmlinuz
      gs://epoxy-mlab-staging/stage2/stage2_vmlinuz
  skip_cleanup: true
  on:
    # TODO: update repo
    repo: m-lab/epoxy-images
    branch: dev

# PRODUCTION: after code review and after QA tests on staging have passed.
